// Prisma schema for Geopolitical Intelligence Workspace

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH MODELS
// ============================================

model User {
  id            String    @id @default(cuid())
  clerkId       String    @unique
  username      String    @unique
  displayName   String?
  bio           String?   @db.Text
  avatarUrl     String?
  isPublic      Boolean   @default(true)
  
  // Credits (in cents, $1.00 = 100 cents)
  creditBalance Int       @default(100)
  
  // Relations - Social
  followers     Follow[]  @relation("Following")
  following     Follow[]  @relation("Followers")
  sentMessages  Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  
  // Relations - Billing
  tokenUsage    TokenUsage[]
  purchases     CreditPurchase[]
  
  // Relations - Owned Data
  tags          QualitativeTag[]
  articles      Article[]
  notes         Note[]
  metricData    CountryMetricData[]
  aggregationJobs DataAggregationJob[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([clerkId])
  @@index([username])
  @@map("users")
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  
  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model Message {
  id          String   @id @default(cuid())
  senderId    String
  receiverId  String
  content     String   @db.Text
  articleId   String?
  isRead      Boolean  @default(false)
  
  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  article     Article? @relation(fields: [articleId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
  
  @@index([senderId])
  @@index([receiverId])
  @@index([senderId, receiverId])
  @@map("messages")
}

model TokenUsage {
  id            String   @id @default(cuid())
  userId        String
  inputTokens   Int
  outputTokens  Int
  costCents     Int      // Actual cost + 20% markup, in cents
  endpoint      String   // e.g., "chat", "aggregation", "score-generation"
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@map("token_usage")
}

model CreditPurchase {
  id              String   @id @default(cuid())
  userId          String
  amountCents     Int      // e.g., 1000 = $10
  stripeSessionId String   @unique
  status          String   @default("pending") // pending, completed, failed
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([stripeSessionId])
  @@map("credit_purchases")
}

// ============================================
// GEOGRAPHY MODELS
// ============================================

model Country {
  id                   String                 @id @default(cuid())
  iso2                 String                 @unique
  iso3                 String                 @unique
  name                 String
  createdAt            DateTime               @default(now())
  
  // Relations
  articleLinks         ArticleCountryLink[]
  metrics              CountryMetrics[]
  industries           IndustryShare[]
  regionMemberships    RegionMembership[]
  metricData           CountryMetricData[]
  aggregationJobs      DataAggregationJob[]
  
  @@index([iso3])
  @@map("countries")
}

enum RegionType {
  LOGICAL_GROUP
  COUNTRY_SPLIT
}

model Region {
  id                   String                 @id @default(cuid())
  name                 String
  type                 RegionType             @default(LOGICAL_GROUP)
  parentId             String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  
  // Relations
  parent               Region?                @relation("RegionHierarchy", fields: [parentId], references: [id])
  children             Region[]               @relation("RegionHierarchy")
  memberships          RegionMembership[]
  
  @@map("regions")
}

model RegionMembership {
  id                   String                 @id @default(cuid())
  regionId             String
  countryId            String
  geometryData         Json?                  // For country splits - stores GeoJSON
  createdAt            DateTime               @default(now())
  
  // Relations
  region               Region                 @relation(fields: [regionId], references: [id], onDelete: Cascade)
  country              Country                @relation(fields: [countryId], references: [id], onDelete: Cascade)
  
  @@unique([regionId, countryId])
  @@index([regionId])
  @@index([countryId])
  @@map("region_memberships")
}

// ============================================
// CONTENT MODELS
// ============================================

model Article {
  id                   String                 @id @default(cuid())
  url                  String                 @unique
  title                String
  source               String?
  publishDate          DateTime?
  summary              String?                @db.Text
  keyNotes             String?                @db.Text
  rawMetadata          Json?                  // Parsed content, HTML, etc.
  
  // User ownership
  userId               String?
  user                 User?                  @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  
  // Relations
  countryLinks         ArticleCountryLink[]
  messages             Message[]
  
  @@index([publishDate])
  @@index([userId])
  @@map("articles")
}

model ArticleCountryLink {
  id                   String                 @id @default(cuid())
  articleId            String
  countryId            String
  createdAt            DateTime               @default(now())
  
  // Relations
  article              Article                @relation(fields: [articleId], references: [id], onDelete: Cascade)
  country              Country                @relation(fields: [countryId], references: [id], onDelete: Cascade)
  
  @@unique([articleId, countryId])
  @@index([articleId])
  @@index([countryId])
  @@map("article_country_links")
}

enum ScopeType {
  COUNTRY
  REGION
}

enum TagCategory {
  ECONOMIC
  SOCIAL
  POLITICAL
  IDEOLOGICAL
}

model QualitativeTag {
  id                   String                 @id @default(cuid())
  scopeType            ScopeType
  scopeId              String
  category             TagCategory
  value                Int                    // -1 = negative, 0 = neutral, 1 = positive
  source               String                 @default("manual") // manual, ai_suggested, auto_from_rules
  note                 String?                @db.Text
  
  // User ownership
  userId               String?
  user                 User?                  @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  createdAt            DateTime               @default(now())
  
  @@index([scopeType, scopeId, category])
  @@index([createdAt])
  @@index([userId])
  @@map("qualitative_tags")
}

model CountryMetrics {
  id                   String                 @id @default(cuid())
  countryId            String
  year                 Int
  population           BigInt?
  immigrationRate      Float?                 // Percentage
  emigrationRate       Float?                 // Percentage
  murdersPerCapita     Float?                 // Per 100k
  warDeathsPercent     Float?                 // Percentage of population
  famineDeathsPercent  Float?                 // Percentage of population
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  
  // Relations
  country              Country                @relation(fields: [countryId], references: [id], onDelete: Cascade)
  
  @@unique([countryId, year])
  @@index([countryId])
  @@index([year])
  @@map("country_metrics")
}

model IndustryShare {
  id                   String                 @id @default(cuid())
  countryId            String
  year                 Int
  industryName         String
  gdpSharePercent      Float
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  
  // Relations
  country              Country                @relation(fields: [countryId], references: [id], onDelete: Cascade)
  
  @@unique([countryId, year, industryName])
  @@index([countryId])
  @@index([year])
  @@map("industry_shares")
}

model Note {
  id                   String                 @id @default(cuid())
  scopeType            ScopeType
  scopeId              String
  content              String                 @db.Text
  
  // User ownership
  userId               String?
  user                 User?                  @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  
  @@index([scopeType, scopeId])
  @@index([userId])
  @@map("notes")
}

enum SuggestionStatus {
  PENDING
  APPROVED
  REJECTED
}

model AISuggestion {
  id                   String                 @id @default(cuid())
  scopeType            ScopeType
  scopeId              String
  suggestionType       String                 // qualitative_tag, metric_update, industry_update, note
  payload              Json                   // Structured data for the suggestion
  citations            Json?                  // Array of URLs and snippets
  status               SuggestionStatus       @default(PENDING)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  
  @@index([scopeType, scopeId, status])
  @@index([status])
  @@map("ai_suggestions")
}

// ============================================
// DEEP DATA AGGREGATION MODELS
// ============================================

// Enum for data source type
enum DataSourceType {
  OFFICIAL
  AGGREGATOR
  NEWS_DERIVED
  INTERPOLATED
  MANUAL
}

// Enum for metric categories
enum MetricCategory {
  ECONOMIC_CORE
  ECONOMIC_MARKET
  LABOR_INCOME
  COST_OF_LIVING
  INDUSTRY
  DEMOGRAPHICS
  HEALTH_WELLBEING
  EDUCATION
  POLITICAL_STRUCTURE
  POLITICAL_SENTIMENT
  SOCIAL_SENTIMENT
  SECURITY
  INFRASTRUCTURE
}

// Master metric definitions
model MetricDefinition {
  id            String             @id @default(cuid())
  code          String             @unique
  name          String
  category      MetricCategory
  unit          String?
  description   String?
  dataType      String             @default("number")
  minValue      Float?
  maxValue      Float?
  isQuarterly   Boolean            @default(false)
  searchHints   String[]           @default([])
  createdAt     DateTime           @default(now())

  dataPoints    CountryMetricData[]

  @@map("metric_definitions")
}

// Actual country data points
model CountryMetricData {
  id              String             @id @default(cuid())
  countryId       String
  metricId        String
  year            Int
  // 0 = annual datapoint; 1-4 = quarterly datapoint
  // IMPORTANT: this is non-null so our unique index + upserts actually work in Postgres.
  quarter         Int                @default(0)
  valueNumeric    Float?
  valueText       String?
  sourceType      DataSourceType
  sourceUrl       String?
  sourceName      String?
  confidenceScore Int?
  aiReasoning     String?
  articleIds      String[]           @default([])
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  createdBy       String?
  
  // User ownership
  userId          String?
  user            User?              @relation(fields: [userId], references: [id], onDelete: SetNull)

  country         Country            @relation(fields: [countryId], references: [id])
  metric          MetricDefinition   @relation(fields: [metricId], references: [id])

  // IMPORTANT: per-user isolation. Without userId in the unique key, users overwrite each other's data.
  @@unique([userId, countryId, metricId, year, quarter])
  @@index([countryId, year])
  @@index([metricId])
  @@index([userId])
  @@map("country_metric_data")
}

// Data aggregation job tracking
model DataAggregationJob {
  id               String    @id @default(cuid())
  countryId        String
  year             Int
  status           String    @default("pending")
  totalMetrics     Int       @default(0)
  completedMetrics Int       @default(0)
  failedMetrics    Int       @default(0)
  currentMetric    String?
  logs             Json[]    @default([])
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  
  // User ownership
  userId           String?
  user             User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  country          Country   @relation(fields: [countryId], references: [id])

  @@index([countryId])
  @@index([status])
  @@index([userId])
  @@map("data_aggregation_jobs")
}
